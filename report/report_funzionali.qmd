---
title: "Report Progetto Dati Funzionali"
author: "Matteo Ceola, Paolo Magagnato, Marco Piccolo, Pietro Stangherlin"
lang: it
format:
  pdf:
    documentclass: article
    toc: true
    number-sections: true

header-includes:
  - \usepackage{graphicx}
  - \usepackage{caption}
---

```{r include=FALSE, echo=FALSE}
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
library(knitr)
```

```{r}
load("../results/prima_parte/outputs/basis_selection_work_space.RData")
```



## Introduzione

## Obbiettivi

-   Analisi esplorative funzionali

-   ANOVA funzionale: confronto tra spettri di frequenze per diverse specie di uccelli

-   Modello funzione su funzione: si è interessati a valutare se esistano delle relazioni tra ciascun suono emesso ed il suono precedente

## Dati

I dati considerati sono presenti sul portale [xeno-canto](https://xeno-canto.org/). Per ogni audio è disponibile la specie di uccello e le coordinate geografiche del rilevamento.

## Operazioni preventive

-   Passaggio al dominio della frequenza tramite spettro medio

-   Normalizzazione delle ampiezze

### Rappresentazione funzionale

#### Spline penalizzate e vincolate

Per le curve di Ampiezza in funzione della frequenza si è scelta una rappresentazione in base bspline di grado 3.
Inizialmente si sono considerate due penalizzazioni: la prima sul numero di basi e la seconda sull'integrale del quadrato della derivata seconda (per un numero di basi abbastanza alto fissato), per entrambi i casi si è considerato come riferimento il parametro che minizzasse il criterio di GCV.
Tuttavia questi due criteri non permettono il rispetto dei vincoli: 
  1) di non negatività della curva
  2) di ampiezza non superiore a 1 (a causa della normalizzazione).
  
Per ciascuno dei due criteri sopra menzionati si sono quindi introdotti i vincoli nel problema di ottimizzazione che può essere scritto come un programma di programmazione quadratica ([A1](#A1)) per cui sono disponibili delle routine.

#### Risultati

Introdurre i vincoli non dà luogo ad uno stimatore lineare in $y$, non è quindi possibile usare GCV come criterio per la selezione dei parametri di regolazione, si impiega invece una procedura di convalida incrociata "Leave One Out" (LOOCV).
A titolo esemplificativo si riportano le curve relative ai gufi con i quattro metodi: GCV senza vincolo e LOOCV con vincolo; in  @tab:representation-selection-df sono riportate le specifiche di ciascun metodo.


```{r}
load("../results/prima_parte/outputs/representation_selection_df.RData")
```


```{r, #tab-representation-selection-df, include= TRUE}
kable(representation_selection_df)
```



![Rappresentazioni funzionali tramite funzioni di base degli spettrogrammi medi dei suoni dei gufi. In alto i criteri non vincolati: a sinistra con il numero di basi selezionate tramite GCV per non penalizzato, a destra con il lambda selezionato con penalità sulla derivata seconda. In basso i criteri vincolati: a sinistra con il numero di basi selezionate tramite convalida incrociata LOOCV per il criterio non penalizzato e a destra con il lambda ottimo con penalità sulla derivata seconda](..\\results\\prima_parte\\images\\gufi_fits_crit.png){#fig-gufi-fits-crit}

Esaminando la @fig-gufi-fits-crit si evidenziano diverse problematiche:

  - nel caso senza vincoli e con penalizzazione solo sul numero di basi (grafico in alto a sinistra) si osserva che non sono rispettati i vincoli di non negatività e di ampiezza inferiore ad uno, problema presente anche con penalizzazione sull'integrale della derivata seconda al quadrato (grafico in alto a destra).
  
- i vincoli migliorano chiaramente la rappresentazione funzionale, tuttavia, il numero di basi che minimizza LOOCV (grafico in basso a sinistra) è probabilmente troppo piccolo in quanto alcune funzioni hanno dei picchi troppo bassi, anche qui si potrebbe pensare di aumentare il numero di basi; nell'ultimo caso (penalizzaione sull'integrale della derivata seconda al quadrato) (grafico in basso a destra) una possibile critica è che le funzioni non siano abbastanza lisce.

```{r}
load("../results/prima_parte/outputs/manual_basis_pars_df.RData")
```


Risultati simili si hanno anche con le altre due specie.
Dato che i criteri di selezione automatica proposti hanno mostrato le problematiche sopra descritte si è deciso di adottare un'euristica in maniera tale che le curve mostrassero un discreto adattamento e al contempo fossero abbastanza lisce. Dopo una serie di prove si sono considerate le funzioni vincolate con penalità sulla derivata seconda riducendo il numero di basi a `r manual_basis_pars_df$basis_num[1]` per tutte le specie.

  
## Medie funzionali

In @fig-fmeansd si riportano le medie e le deviazioni standard funzionali per tutti i gruppi di ciascun animale. Le deviazioni standard sono circa dello stesso ordine delle medie per quasi tutti i gruppi e tutti i punti.

Per i falchi le medie e le deviazioni standard dei gruppi hot e temperate appaiono vicine nel ragne di frequenze tra 3khz e 4.5khz, mentre fuori da questo intervallo presentano differenze sia in media che in varianza, rimandendo comunque sempre sopra le curve del gruppo cold.

Come per i falchi anche per i gufi le curve medie nei tre gruppi sembrano seguire un andamente comune, così come le deviazioni standard, qui le due curve più vicine sono invece quelle dei gruppi cold e temperate. Risalta il picco nei pressi dello zero, ciò potrebbe essere semplicemente un artefatto numerico.

Nei gabbiani la curva media che di discosta dalle altre è quella relativa al gruppo delle Canarie che domina le altre curve alle frequenze basse, mentre per quelle più alta è sotto tutte le altre curve medie. Si nota inolte un picco nella funzione media e un doppio picco per la deviazione standard intorno ai 3.5 khz per il gruppo Centre.

![Medie Funzionali degli spettrogrammi medi dei suoni degli animali per i diversi gruppi a cui è aggiunto e sottrato l'errore standard funzionale. Da sinistra verso destra falchi, gufi e gabbiani](..\\results\\prima_parte\\images\\f_mean_sd.png){#fig-fmeansd}

## PCA funzionale

Si effettua un'analisi delle componenti principali funzionali, sia per avere delle ulteriori informazioni descrittive sia per vedere se i punteggi di tali componenti individuano o meno dei cluster di osservazioni potenzialmente diversi da quelli scelti in questa sede.

Inizialmente si fissa un numero di armoniche pari a 10 (@fig-f_pca_explained_var), per i falchi le prime 3 componenti spiegano circa l'80% della varianza, per i gufi sono necessarie 4 componenti per spiegare circa l'80% della varianza, mentre per i gabbiani l'85% della varianza è spiegato dalle prime tre componenti.

![Varianza spiegata cumulata per le prime 10 componenti funzionali principali degli spettrogrammi dei suoni (dall'alto in basso) di falchi, gufi e gabbiani](..\\results\\prima_parte\\images\\f_pca_explained_var.png){#fig-f_pca_explained_var}

Focalizzandosi sulle prime tre armoniche (@fig-f_pca_harmonics) si può vedere che, per tutti gli animali, la prima armonica segue abbastanza la forma della media funzionale, la seconda presenta un andamento opposto alla media e la terza varia molto tra i diversi animali e non è di facile intepretazione.

![Prime tre armoniche (da sinistra verso destra) con piccoli scostamenti dalla media relative alle componenti principali funzionali degli spettrogrammi dei suoni (dall'alto in basso) di falchi, gufi e gabbiani](..\\results\\prima_parte\\images\\f_pca_harmonics.png){#fig-f_pca_harmonics}
Considerando le prime due armoniche (ma un risultato analogo si ottiene anche con le prime tre) e rappresentando graficamente i punteggi (@fig-f_pca_scores) non si distingue nessun cluster di punti.

![Punteggi delle prime due armoniche relative alle componenti principali funzionali degli spettrogrammi dei suoni (dall'alto in basso) di falchi, gufi e gabbiani](..\\results\\prima_parte\\images\\f_pca_scores.png){#fig-f_pca_scores}


## ANOVA funzionale


\begin{figure}[ht]
\centering
\begin{minipage}{0.48\textwidth}
  \centering
  \includegraphics[width=\linewidth]{"../results/prima_parte/images/f_beta_quant_falchi.png"}
\end{minipage}
\hfill
\begin{minipage}{0.48\textwidth}
  \centering
  \includegraphics[width=\linewidth]{"../results/prima_parte/images/f_beta_quant_gufi.png"}
\end{minipage}

\vspace{0.5cm}

\begin{minipage}{0.6\textwidth}
  \centering
  \includegraphics[width=\linewidth]{"../results/prima_parte/images/f_beta_quant_gabbiani.png"}
\end{minipage}

\caption{Coefficienti del modelli di ANOVA funzionale, le bande intorno a ciascun coefficiente funzionale sono intervalli puntuali bootstrap (stratificato per gruppi) (`r N_BOOT` campioni bootstrap) relativi ai percentili 2.5% e 97.5%. In alto da sinistra verso destra i modelli per falchi e gufi, in basso per gabbiani.}
\end{figure}


![Grafici associati ai test F funzionali per ciascun modello di ANOVA funzionale. La linea continua rappresenta la statistica osservata, quella trattettagia il percentile puntuale al 95% della statistica F sotto l'ipotesi nulla stimato tramite permutazione (`r N_PERM` permutazioni)  e la linea rossa è il percentile al 95% dei massimi delle statistiche F sotto l'ipotesi nulla.](..\\results\\prima_parte\\images\\f_anova_f_test.png){#fig-f-anova-f-test}


## Modello funzione su funzione

## Conclusioni

## Appendice
### A1
Il programma di ottimizzazione quadratica nella sua forma più generale è definito come

$$
\text{min}_{b}(-d^Tb + 1/2b^TDb) \text{ s.t. } A^Tb \geq b_0
$${#eq-qp}
Per una singola osservazione funzionale, per il lisciamento tramite scrittura in funzioni di base la funzione da minimizzare rispetto a $b$ è

$$
(y - \Phi b)^T(y - \Phi b) + \lambda b^T Pb
$${#eq-basisloss}
dove $y$ è il vettore dei punti osservati $\Phi$ è la matrice delle funzioni di base valutate nei punti osservati del dominio della curva e $b$ è il vettore dei coefficienti, $P$ è una generica matrice di penalità e $\lambda > 0$ indica l'entità della penalizzaione (per un criterio non penalizzato è sufficiente porre $\lambda = 0$).
Minizzare l' @eq-basisloss equivale a minizzare 

$$
-y^T \Phi b + b^T \frac{1}{2}(\Phi^T \Phi + \lambda P) b
$${#eq-basislossexp}

Da cui $d = y^T \Phi$ e $D = \Phi^T \Phi + \lambda P$.
Usando la definizione di scrittura in basi il vincolo è $0 \leq \phi^T(f)b \leq 1 \quad \forall f$, in pratica si discretizza $\phi(f_j)$ per $j = 1,..,J$.
Sia $\Phi_J$ la matrice di funzioni di base valuate su griglia discretizzata: deve valere $\Phi_J b \leq \mathbb{1}$ o equivalentemente $-\Phi_J b \geq -\mathbb{1}$ dove con questa scrittura si intende che la disuguaglianza deve valere per ogni elemento dei vettori.
Similmente, per vincolo di positività si ha $\Phi_J b \geq \mathbb{0}$, tuttavia, poichè per costruzione le basi bspline sono sempre non negative è sufficiente imporre $\mathbb{I}_J b \geq \mathbb{0}$ con $\mathbb{I}_J$ matrice identità. Combinando le due espressioni si ottiene 

$$ \begin{pmatrix}
-\Phi\\
\mathbb{I}_J
\end{pmatrix} b \geq \begin{pmatrix}
-\mathbb{1}\\
\mathbb{0}
\end{pmatrix}$$

chiaramente $A = (-\Phi^T \quad \mathbb{I}_j)$ e $b_0 = (-\mathbb{1} \quad \mathbb{0})^T$, è dunque conclusa la scrittura del problema vincolato come programma quadratico.

